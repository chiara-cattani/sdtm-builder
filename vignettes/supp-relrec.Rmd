---
title: "SUPP and RELREC Domains"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SUPP and RELREC Domains}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
 collapse = TRUE,
 comment  = "#>",
 eval     = FALSE
)
```

# Supplemental Qualifiers (SUPP--) and RELREC

## Background

CDISC SDTM limits domains to a specific set of standard variables. When a study
captures additional data that maps to a domain but does not fit a standard
variable, it goes into a **Supplemental Qualifier** dataset (e.g., SUPPAE,
SUPPLB).

`sdtmbuilder` handles SUPP generation automatically during `finalize_domain()`.

## How It Works

### 1. Mark Non-Standard Variables in Study_Metadata.xlsx

In the **Variables** sheet, set `CORE = "SUPP"` for any variable that should
be routed to the supplemental qualifier dataset:

| DOMAIN | VARIABLE | LABEL | CORE | DATA_TYPE | METHOD |
|--------|----------|-------|------|-----------|--------|
| AE | AEACNOTH | Other Action Taken | SUPP | text | `{"rule_type": "direct_map", ...}` |

### 2. Automatic Routing

When `finalize_domain()` runs, it:

1. Identifies variables with `CORE == "SUPP"`
2. Pivots them into the SUPP-- structure (QNAM, QLABEL, QVAL, QORIG, QEVAL)
3. Links them back to the parent domain via USUBJID + --SEQ
4. Produces the companion RELREC entries

### 3. Build Call (No Special Arguments Needed)

```{r}
library(sdtmbuilder)

meta <- read_study_metadata_excel("inst/extdata/Study_Metadata.xlsx")
ct   <- read_study_ct_excel("inst/extdata/Study_CT.xlsx")

target_meta <- meta$target_meta
ct_lib      <- ct$ct_lib

config   <- new_sdtm_config(study_id = "STUDY01")
raw_data <- load_raw_data(config)
rule_set <- compile_rules(target_meta, ct_lib = ct_lib)

result <- build_domain(
  domain      = "AE",
  target_meta = target_meta,
  raw_data    = raw_data,
  config      = config,
  rule_set    = rule_set
)
```

### 4. Inspecting the Output

```{r}
# Main domain dataset
head(result$data)

# Supplemental qualifier dataset (SUPPAE)
head(result$supp)

# Relationship records
head(result$relrec)
```

The `result$supp` tibble has the standard CDISC SUPP-- columns:

| Column | Description |
|--------|-------------|
| STUDYID | Study identifier |
| RDOMAIN | Parent domain code (e.g., "AE") |
| USUBJID | Unique subject identifier |
| IDVAR | Key variable in parent ("AESEQ") |
| IDVARVAL | Value of the key variable |
| QNAM | Qualifier variable name (e.g., "AEACNOTH") |
| QLABEL | Qualifier label |
| QVAL | Qualifier value |
| QORIG | Origin (e.g., "CRF") |
| QEVAL | Evaluator (if applicable) |

## Building SUPP Manually

If you need more control, use `build_supp()` directly:
```{r}
supp <- build_supp(
  domain_data = result$data,
  target_meta = target_meta,
  domain      = "AE"
)
```

## Building RELREC

`build_relrec()` creates the relationship records linking parent and SUPP:

```{r}
relrec <- build_relrec(
  parent_domain = "AE",
  supp_data     = supp,
  study_id      = "STUDY01"
)
```

## Exporting

```{r}
# Export all three datasets
export_xpt(result$data,   file.path("output", "ae.xpt"))
export_xpt(result$supp,   file.path("output", "suppae.xpt"))
export_xpt(result$relrec, file.path("output", "relrec.xpt"))
```
