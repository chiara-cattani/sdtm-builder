---
title: "Build Pipeline"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Build Pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# sdtmbuilder Build Pipeline

This vignette walks through the recommended end-to-end pipeline for
building one or more SDTM domains with `sdtmbuilder`.

---

## 1. Pipeline Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     sdtmbuilder Pipeline                        │
│                                                                 │
│  Step 1 ─ Configure   ───► new_sdtm_config()                   │
│  Step 2 ─ Ingest      ───► read_study_metadata_excel()          │
│                             read_study_ct_excel()               │
│  Step 3 ─ Validate    ───► validate_study_metadata()            │
│  Step 4 ─ Compile     ───► compile_rules()                      │
│  Step 5 ─ Dependency  ───► build_dependency_graph()              │
│                             topo_sort_rules()                   │
│  Step 6 ─ Load Data   ───► load_raw_datasets()                 │
│  Step 7 ─ Build       ───► build_domain()                       │
│  Step 8 ─ Validate    ───► validate_domain_structure()           │
│  Step 9 ─ Export      ───► export_domain()                      │
│  Step 10─ Codegen     ───► gen_domain_script() [optional]        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Step-by-Step Walkthrough

### Step 1: Configure the Study

```r
library(sdtmbuilder)

cfg <- new_sdtm_config(
  studyid        = "CDISCPILOT01",
  timezone       = "UTC",
  ref_start_rule = list(var = "RFSTDTC", source = "DM"),
  visit_map      = readr::read_csv("metadata/visit_map.csv"),
  imputation_policy = list(day = "first", month = NULL, year = NULL),
  log_level = "INFO"
)
```

### Step 2: Ingest Metadata

```r
# Read the two metadata workbooks
study_meta  <- read_study_metadata_excel("metadata/Study_Metadata.xlsx")
target_meta <- study_meta$target_meta
ct_lib      <- read_study_ct_excel("metadata/Study_CT.xlsx")

# Bundle them
mb <- new_meta_bundle(
  target_meta = target_meta,
  ct_lib      = ct_lib
)
```

Source metadata is automatically inferred from your raw data — no separate
file needed.

### Step 3: Validate Metadata

```r
# Structural validation
validate_target_meta(mb$target_meta)
validate_ct_library(mb$ct_lib)

# Cross-sheet validation
validate_study_metadata(study_meta, ct_lib)

# Normalize (uppercase domain/var, trim whitespace, etc.)
mb$target_meta <- normalize_target_meta(mb$target_meta)
```

### Step 4: Compile Rules

```r
rule_set <- compile_rules(mb$target_meta, ct_lib = mb$ct_lib)
print(rule_set)
```

### Step 5: Resolve Dependencies

```r
domains <- unique(mb$target_meta$domain)

for (dom in domains) {
  dep <- build_dependency_graph(rule_set, dom)
  cycles <- detect_cycles(dep)
  if (length(cycles) > 0) {
    cli::cli_abort("Circular dependency in {dom}: {cycles}")
  }
}
```

### Step 6: Load Raw Data

```r
# Load all raw datasets from a directory
raw_data <- load_raw_datasets("rawdata/", pattern = "\\.csv$")
```

### Step 7: Build Domains

```r
# Build all at once (recommended)
results <- build_all_domains(
  target_meta = mb$target_meta,
  raw_data    = raw_data,
  config      = cfg,
  rule_set    = rule_set,
  verbose     = TRUE
)

# Or one at a time
dm <- build_domain("DM", mb$target_meta, raw_data, cfg, rule_set)
ae <- build_domain("AE", mb$target_meta, raw_data, cfg, rule_set,
                   dm_data = dm$data)
```

### Step 8: Validate

```r
for (dom in names(results)) {
  report <- results[[dom]]$report
  summary <- summarize_validation_report(report)
  log_info("{dom}: {summary$n_errors} errors, {summary$n_warnings} warnings")
}
```

### Step 9: Export

```r
output_dir <- "output/sdtm"
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

for (dom in names(results)) {
  export_domain(results[[dom]]$data, dom, output_dir,
                formats = c("xpt", "rds"), target_meta = mb$target_meta)
}
```

### Step 10 (Optional): Generate Reproducible Scripts

```r
script_dir <- "programs/sdtm"
dir.create(script_dir, recursive = TRUE, showWarnings = FALSE)

for (dom in names(results)) {
  gen_domain_script(domain = dom, rule_set = rule_set,
                    target_meta = mb$target_meta, config = cfg,
                    output_path = file.path(script_dir, paste0(tolower(dom), ".R")))
}
```

---

## 3. Recommended Domain Build Order

| Phase | Domains | Reason |
|-------|---------|--------|
| 1. Trial Design | TA, TV, TE, TS | Reference data for all other domains |
| 2. Demographics | DM | RFSTDTC, RFENDTC, USUBJID baseline |
| 3. Subject-level | SV, SE | Visit / element structure |
| 4. Interventions | CM, EX | Concomitant meds, exposure |
| 5. Events | AE, DS, MH | Adverse events, disposition, medical history |
| 6. Findings | LB, VS, EG, PE, QS | Labs, vitals, ECG, physical exam |
| 7. Supplemental | SUPPAE, SUPPCM, ... | After parent domain is built |
| 8. Relationships | RELREC | After all linked domains exist |

---

## 4. Single-Domain Quick Build

For rapid iteration on a single domain:

```r
library(sdtmbuilder)

# Using make_dummy_study for quick testing
study <- make_dummy_study(seed = 42)
rs    <- compile_rules(study$target_meta, ct_lib = study$ct_lib)

dm <- build_domain("DM", study$target_meta, study$raw_data,
                   study$config, rs)
ae <- build_domain("AE", study$target_meta, study$raw_data,
                   study$config, rs, dm_data = dm$data)

vr <- validate_domain_structure(ae$data, study$target_meta, "AE",
                                study$config, study$ct_lib)
print(vr)

export_domain(ae$data, "AE", tempdir(), target_meta = study$target_meta)
```

---

## 5. Error Handling Strategy

Throughout the pipeline, `sdtmbuilder` uses structured error handling:

- **Fatal errors** (`stop_with_context()`): Missing required metadata,
  circular dependencies. Pipeline halts.
- **Warnings** (`warn_with_context()`): Unexpected CT values, duplicate
  records resolved by rule, partial dates. Pipeline continues; findings
  collected in the validation report.
- **Informational** (`log_info()`): Progress messages, row counts, timing.

All messages include contextual metadata (domain, variable, rule type) for
easy debugging.
