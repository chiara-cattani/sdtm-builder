---
title: "Architecture Overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Architecture Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# sdtmbuilder Architecture

## High-Level Module Diagram

```
           ┌──────────────────────────────┐
           │   Study Config + CT Libs      │
           │ (paths, rules, overrides)     │
           │ new_sdtm_config()             │
           └──────────────┬───────────────┘
                          │
  ┌───────────────────────▼────────────────────────────┐
  │                 Metadata Layer (B + C)              │
  │                                                     │
  │  read_study_metadata_excel() →  validate_study_*()  │
  │  read_study_ct_excel()       →  validate_ct_*()     │
  │  infer_source_meta()         (auto from raw data)   │
  │  normalize_*()       →  expand_value_level_meta()   │
  │  apply_study_overrides() → resolve_domain_model()   │
  │                                                     │
  │  compile_rules() → parse_rule_json/dsl()            │
  │  validate_rules() → enrich_rules_with_ct()          │
  │  infer_rule_dependencies() → canonicalize_rules()   │
  └────────────┬───────────────────────┬───────────────┘
               │                       │
    ┌──────────▼──────────┐   ┌────────▼───────────────┐
    │   Data Access (E)    │   │ Dependency System (D)  │
    │                      │   │                         │
    │ load_raw_datasets()  │   │ build_dependency_graph()│
    │ standardize_names()  │   │ topo_sort_rules()       │
    │ standardize_names()  │   │ detect_cycles()         │
    │ standardize_types()  │   │ resolve_late_binding()  │
    │ apply_missing_conv() │   │ plan_build_steps()      │
    │ derive_core_keys()   │   │                         │
    │ get_subject_level()  │   │                         │
    └──────────┬──────────┘   └────────┬───────────────┘
               │                       │
    ┌──────────▼──────────┐   ┌────────▼───────────────┐
    │ Join & Assembly (F)  │   │ Derivation Library (G) │
    │                      │   │                         │
    │ safe_join()          │   │ map_direct()            │
    │ resolve_keys()       │   │ derive_constant()       │
    │ deduplicate_by_rule()│   │ derive_coalesce()       │
    │ bind_sources()       │   │ derive_if_else()        │
    │ split_records()      │   │ derive_case_when()      │
    │ expand_checkbox()    │   │ assign_ct() / decode_ct │
    │ expand_visits()      │   │ parse_partial_date()    │
    │                      │   │ format_iso_dtc()        │
    │                      │   │ derive_dy() / _epoch()  │
    │                      │   │ derive_visit*()         │
    │                      │   │ derive_seq()            │
    │                      │   │ derive_baseline_flag()  │
    │                      │   │ derive_status()         │
    └──────────┬──────────┘   └────────┬───────────────┘
               │                       │
               └───────────┬───────────┘
                           │
               ┌───────────▼──────────────┐
               │   Domain Builders (H)     │
               │                           │
               │ build_domain()            │
               │ build_all_domains()       │
               │ build_domain_from_sources │
               │ apply_domain_rules()      │
               │ derive_variable()         │
               │ finalize_domain()         │
               │ build_supp()              │
               │ build_relrec()            │
               │                           │
               │ Plugins:                  │
               │  build_dm_plugin()        │
               │  build_sv_plugin()        │
               │  build_ta_tv_te_ts_*()    │
               └───────────┬──────────────┘
                           │
          ┌────────────────▼──────────────────┐
          │   Validation & QC (I)              │
          │                                    │
          │ validate_domain_structure()        │
          │ validate_required_vars()           │
          │ validate_keys_unique()             │
          │ validate_iso8601()                 │
          │ validate_lengths_types_labels()    │
          │ validate_ct_conformance()          │
          │ validate_value_level()             │
          │ validate_cross_domain()            │
          │ summarize_validation_report()      │
          └────────────────┬──────────────────┘
                           │
     ┌─────────────────────▼────────────────────────┐
     │ Code Generation (J)  +  Export (K)            │
     │                                               │
     │ gen_domain_script()   export_domain()          │
     │ gen_qmd_domain()      write_define_support()   │
     │ gen_project_scaffold() write_define_support()  │
     │ serialize_rules_*()   write_codelist_support() │
     │                       write_value_level_*()    │
     │                       write_origin_support()   │
     └───────────────────────────────────────────────┘

     Cross-cutting: Module A (primitives) + Module L (utilities)
```

## Data Flow

```
  ┌──────────────┐                 ┌─────────┐
  │ Study_       │                 │ Study_  │
  │ Metadata.xlsx│                 │ CT.xlsx │
  └──────┬───────┘                 └────┬────┘
         │                              │
         ▼                              ▼
  read_study_            read_study_
  metadata_excel()       ct_excel()
         │                              │
         ▼                              │
  validate_study_metadata() ◄───────────┘
         │                              │
         ▼                              ▼
  target_meta +                    ct_lib
  domain_meta +
  value_level_meta
         │                              │
         └──────────┬───────────────────┘
                    ▼
             compile_rules()
                    │
                    ▼
             new_rule_set()
                    │
             ┌──────┴──────┐
             ▼              ▼
        build_dep_     load_raw
        graph()        _data()
             │              │
             ▼              ▼
        topo_sort     standardize
        _rules()       _names/types()
             │              │
             └──────┬───────┘
                    ▼
             build_domain()
             ├─ build_domain_from_sources()
             ├─ apply_domain_rules()
             │   └─ derive_variable() × N
             ├─ finalize_domain()
             │   └─ build_supp()
             └─ validate_domain()
                    │
                    ▼
             build_result
             ├─ data (tibble)
             ├─ supp (tibble)
             ├─ relrec (tibble)
             ├─ report (validation_report)
             └─ provenance (tibble)
                    │
             ┌──────┴──────┐
             ▼              ▼
        export_domain()   gen_domain_script()
        write_define   gen_qmd_domain()
        _support()
```

## Recommended Default Build Order

| Step | Phase | Action | Dependencies |
|------|-------|--------|-------------|
| 1 | Meta | `read_study_metadata_excel()` → `validate_*()` | None |
| 2 | Meta | `compile_rules()` → `validate_rules()` | Step 1 |
| 3 | Plan | `build_dependency_graph()` → `topo_sort_rules()` | Step 2 |
| 4 | Data | `load_raw_datasets()` → `standardize_*()` | Step 1 |
| 5 | Build | Trial design: `build_ta_tv_te_ts_plugins()` | Steps 1-4 |
| 6 | Build | **DM**: `build_dm_plugin()` | Steps 1-4 |
| 7 | Build | **SV**: `build_sv_plugin()` | Step 6 |
| 8 | Build | Events: AE, DS, MH, ... | Steps 6-7 |
| 9 | Build | Interventions: CM, EX, ... | Steps 6-7 |
| 10 | Build | Findings: LB, VS, ... | Steps 6-7 |
| 11 | Export | `export_domain()` + `write_define_support()` | Steps 6-10 |
| 12 | CodeGen | `gen_domain_script()` | Step 2 |

Within each domain, variable derivation order follows the topological sort
from `build_dependency_graph()`:

1. Constants (STUDYID, DOMAIN)
2. Core keys (USUBJID)
3. Direct mappings (--TERM, --CAT, ...)
4. CT assignments (--TESTCD, --TEST, --SEV, ...)
5. Date/time (--DTC)
6. Study day (--DY)
7. Visit variables (VISIT, VISITNUM, VISITDY)
8. Epoch (EPOCH)
9. Flags (--BLFL, --STAT, --OCCUR)
10. Sequence (--SEQ) — always last
11. SUPP move + RELREC (post-finalization)
