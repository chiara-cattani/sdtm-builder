---
title: "Metadata Schema Reference"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Metadata Schema Reference}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>"
)
```

# Metadata Schema Reference

This vignette documents the schema for the two Excel metadata files used by
`sdtmbuilder`.

## 1 Study_Metadata.xlsx

This is the primary metadata workbook. It contains the following sheets:

### 1.1 Domains Sheet

Defines which SDTM domains are in scope for the study.

| Column | Type | Required | Description |
|--------|------|----------|-------------|
| DOMAIN | character | Yes | Two-letter SDTM domain code (e.g., "DM", "AE") |
| DESCRIPTION | character | Yes | Human-readable domain description |
| CLASS | character | No | SDTM class (Events, Findings, Interventions, …) |
| STRUCTURE | character | No | Record structure ("One record per subject per event", …) |
| REPEATING | character | No | "Yes" or "No" |

### 1.2 Variables Sheet

Defines every target variable and its derivation rule.

| Column | Type | Required | Description |
|--------|------|----------|-------------|
| DOMAIN | character | Yes | Parent domain code |
| VARIABLE | character | Yes | SDTM variable name (e.g., "AESTDTC") |
| LABEL | character | Yes | Variable label (max 40 characters) |
| DATA_TYPE | character | Yes | "text", "integer", "float", "datetime", "date" |
| LENGTH | integer | No | Maximum character length (text) or display width |
| SIGNIFICANT_DIGITS | integer | No | Number of significant digits (float variables) |
| CORE | character | No | "Req", "Perm", "Exp", or "SUPP" |
| CODELIST | character | No | Codelist code from Study_CT.xlsx (e.g., "SEV") |
| ORIGIN | character | No | Variable origin: "CRF", "Derived", "Assigned", "Protocol" |
| METHOD | character | No | Derivation rule — NA for auto-assign, or JSON string |
| VALUE | character | No | Constant value (when METHOD implies constant) |
| ORDER | integer | No | Display order within the domain |

#### METHOD Auto-Assignment

When `METHOD` is `NA`, `compile_rules()` applies these defaults:

- **STUDYID** → `rule_type = "constant"` (from `config$studyid`)
- **DOMAIN** → `rule_type = "constant"` (from the domain code)
- **All others** → `rule_type = "direct_map"` with:
  - `dataset = "{tolower(domain)}_raw"`
  - `column = "{tolower(variable)}"`

### 1.3 ValueLevel Sheet (Optional)

Defines value-level metadata for variables that vary by test code or category.

| Column | Type | Required | Description |
|--------|------|----------|-------------|
| DOMAIN | character | Yes | Domain code |
| VARIABLE | character | Yes | Variable that triggers the split (e.g., "LBTESTCD") |
| VALUE | character | Yes | Specific value of VARIABLE |
| TARGET_VARIABLE | character | Yes | Variable being defined at value level |
| LABEL | character | No | Value-level label |
| DATA_TYPE | character | No | Override data type |
| LENGTH | integer | No | Override length |
| CODELIST | character | No | Override codelist |
| ORIGIN | character | No | Override origin |
| METHOD | character | No | Override derivation method |

### 1.4 StudyInfo Sheet (Optional)

Global study-level metadata.

| Column | Type | Description |
|--------|------|-------------|
| STUDYID | character | Study identifier |
| STUDY_NAME | character | Full study name |
| PROTOCOL | character | Protocol number |
| SPONSOR | character | Sponsor name |
| THERAPEUTIC_AREA | character | Therapeutic area |
| PHASE | character | Study phase |

### 1.5 TrialDesign Sheet (Optional)

Defines trial arms, elements, and visits for TA/TV/TE domains.

### 1.6 Overrides Sheet (Optional)

Study-specific overrides applied via `apply_study_overrides()`.

### 1.7 Imputation Sheet (Optional)

Date imputation policies applied via `apply_imputation_policy()`.

## 2 Study_CT.xlsx

Controlled terminology workbook with two sheets:

### 2.1 CT_Codelists Sheet

| Column | Type | Required | Description |
|--------|------|----------|-------------|
| CODELIST_CODE | character | Yes | Short unique identifier (e.g., "SEV", "YN") |
| CODELIST_NAME | character | Yes | Human-readable name |
| EXTENSIBLE | character | No | "Yes" or "No" — whether non-listed terms are permitted |
| NCI_CODELIST_CODE | character | No | NCI EVS C-code (e.g., "C66767") |

### 2.2 CT_Terms Sheet

| Column | Type | Required | Description |
|--------|------|----------|-------------|
| CODELIST_CODE | character | Yes | FK to CT_Codelists.CODELIST_CODE |
| TERM_CODE | character | Yes | Submission value / coded value |
| TERM_DECODE | character | No | Decoded (human-readable) value |
| NCI_TERM_CODE | character | No | NCI EVS C-code for the term |
| ORDER_NUMBER | integer | No | Display order within codelist |

### Example

```{r}
library(sdtmbuilder)

ct <- read_study_ct_excel(
  system.file("extdata", "Study_CT.xlsx", package = "sdtmbuilder")
)

# Codelist definitions
ct$ct_codelist
#> # A tibble: 5 × 4
#>   CODELIST_CODE CODELIST_NAME NCI_CODELIST_CODE EXTENSIBLE
#>   <chr>         <chr>         <chr>             <chr>
#> 1 YN            Yes / No      NA                No
#> 2 LBTESTCD      Lab Test Code NA                Yes
#> 3 LBTEST        Lab Test Name NA                Yes
#> 4 UNIT          Units         NA                Yes
#> 5 SEX           Sex           NA                No

# CT terms
ct$ct_lib
#> # A tibble: 16 × 4
#>   CODELIST_CODE TERM_CODE TERM_DECODE CODELIST_NAME
#>   <chr>         <chr>     <chr>       <chr>
#> 1 YN            Y         Yes         Yes / No
#> 2 YN            N         No          Yes / No
#> 3 LBTESTCD      ALB       Albumin     Lab Test Code
#> …
```

## 3 Source Metadata (Auto-Inferred)

`sdtmbuilder` does **not** require a separate source metadata file. Source
metadata is automatically inferred from the raw datasets at build time via
`infer_source_meta()`:
```{r eval=FALSE}
raw_data    <- load_raw_datasets("raw")
source_meta <- infer_source_meta(raw_data)
```

The inferred `source_meta` tibble contains:

| Column | Description |
|--------|-------------|
| DATASET | Source dataset name (from the names of `raw_data`) |
| VARIABLE | Column name |
| TYPE | R type class (character, numeric, integer, Date, …) |
| LABEL | Column label (from `attr(x, "label")` if present) |

This is used internally by the build pipeline and does not need to be supplied
by the user.
