# =============================================================================
# sdtmbuilder — Study Configuration for STUDY-PILOT
# =============================================================================
# This file controls all preferences, paths, and mappings used by run_study().
# Section 1: Study identity & global preferences (edit once at study start)
# Section 2: Study-specific mappings (visits, timepoints, criteria, relrec)
# =============================================================================


# *****************************************************************************
# SECTION 1 — STUDY PREFERENCES
# *****************************************************************************
# Set these at the beginning of the study. They rarely change once defined.
# *****************************************************************************

# --- 1.1  Study identity ------------------------------------------------------
studyid: "STUDY-PILOT"                  # Unique study identifier
timezone: "UTC"                          # Timezone for date/time conversions
                                         #   e.g. "UTC", "US/Eastern", "Europe/Berlin"

# --- 1.2  Paths ---------------------------------------------------------------
# Relative to where run_study() is called (typically the study root), or absolute.
paths:
  metadata: "metadata/Study_Metadata.xlsx"   # Study_Metadata.xlsx location
  ct: "metadata/Study_CT.xlsx"               # Study_CT.xlsx location
  raw_data: "raw"                            # Directory containing raw datasets
  output: "sdtm/datasets"                    # Export directory for XPT/RDA files
  programs: "sdtm/programs"                  # Directory for generated R programs

# --- 1.3  Export options -------------------------------------------------------
export:
  formats:                               # Which output formats to produce
    - "xpt"                              #   "xpt" = SAS transport file
    - "rda"                              #   "rda" = R binary (.rda)
  xpt_version: 8                         # SAS transport version
                                         #   8 = SAS Transport v8 (default, recommended)
                                         #   5 = SAS Transport v5 (legacy CDISC)
  generate_programs: true                # true  = write an R program per domain
                                         # false = datasets only, no scripts

# --- 1.4  Study day convention ------------------------------------------------
study_day:
  convention: "no_day_zero"              # "no_day_zero" = CDISC standard
                                         #   Day before RFSTDTC is -1, day of RFSTDTC is 1
                                         #   (no Day 0 exists)

# --- 1.5  Logging -------------------------------------------------------------
log_level: "INFO"                        # Verbosity of console messages
                                         #   "DEBUG" = everything (very verbose)
                                         #   "INFO"  = normal progress messages (default)
                                         #   "WARN"  = only warnings and errors
                                         #   "ERROR" = only errors

# --- 1.6  Policies ------------------------------------------------------------
# Rules governing how the engine handles edge cases during derivation.
policies:
  unknown_ct: "WARN_AND_KEEP"            # What to do when a value is not in the CT
                                         #   "WARN_AND_KEEP" = keep original, log warning (default)
                                         #   "WARN_AND_DROP" = set to NA, log warning
                                         #   "ERROR"         = stop with an error
  date_partial_allowed: true             # true  = allow partial ISO dates (e.g. "2025-01")
                                         # false = require complete dates
  imputation:                            # Date imputation when partial dates are allowed
    day: "first"                         #   "first" = impute to 1st of the month (default)
                                         #   "last"  = impute to last day of the month
                                         #   "mid"   = impute to the 15th
                                         #   null    = no imputation
    month: null                          #   "first" / "last" / "mid" / null
    year: null                           #   "first" / "last" / "mid" / null
  join_cardinality_default: "m:1"        # Default join cardinality for merge rules
                                         #   "m:1"  = many-to-one (default, most common)
                                         #   "1:1"  = one-to-one
                                         #   "1:m"  = one-to-many
                                         #   "m:m"  = many-to-many
  blank_is_na: true                      # true  = treat blank strings as NA (default)
                                         # false = blanks are kept as ""
  na_strings:                            # Additional strings treated as NA when reading raw data
    - "."
    - "UNK"
    - "NA"

# --- 1.7  SUPP domain generation ----------------------------------------------
create_supp: true                        # true  = generate SUPP-- datasets (e.g. SUPPAE)
                                         # false = no supplemental qualifier datasets

# --- 1.8  Sponsor overrides ---------------------------------------------------
# Key-value pairs that override default behavior for specific derivations.
# Leave empty {} if none are needed.
sponsor_overrides: {}

# --- 1.9  Reference start date ------------------------------------------------
# How to find RFSTDTC (reference start date) for --DY and epoch derivations.
# sdtm: reads from the built DM domain (primary, used once DM is built)
# raw:  fallback raw variable (used when DM hasn't been built yet)
ref_start_date:
  sdtm:
    domain: "DM"
    variable: "RFSTDTC"
    # path: "path/to/dm.sas7bdat"        # (optional) explicit path to DM SDTM dataset
  raw:
    dataset: "dm"
    variable: "icdat"


# *****************************************************************************
# SECTION 2 — STUDY MAPPINGS
# *****************************************************************************
# Define study-specific visit schedules, timepoints, criteria, and
# related records below. These are study-dependent and typically longer.
# *****************************************************************************

# --- 2.1  Visit map -----------------------------------------------------------
# Maps the raw visit identifier to VISIT, VISITNUM, VISITDY, and
# optionally TVSTRL (planned visit window text for TV domain).
visit_source_var: "eventid"
visit_map:
  - code: "SCR"
    visit: "Visit 0: Screening"
    visitnum: 1
    visitdy: 1
    tvstrl: "Between Day -28 and Day 1"
  - code: "V1"
    visit: "Visit 1"
    visitnum: 2
    visitdy: 1
    tvstrl: "Day 1"
  - code: "V1_IMG"
    visit: "Visit 1"
    visitnum: 2
    visitdy: 1
  - code: "PW1"
    visit: "Phone Call 1"
    visitnum: 3
    visitdy: 8
    tvstrl: "Day 8 +/- 2 days"
  - code: "PW5"
    visit: "Phone Call 2"
    visitnum: 4
    visitdy: 36
    tvstrl: "Day 36 +/- 3 days"
  - code: "V2"
    visit: "Visit 2"
    visitnum: 5
    visitdy: 71
    tvstrl: "Day 71 +/- 5 days"
  - code: "PW15"
    visit: "Phone Call 3"
    visitnum: 6
    visitdy: 106
    tvstrl: "Day 106 +/- 3 days"
  - code: "PW20"
    visit: "Phone Call 4"
    visitnum: 7
    visitdy: 140
    tvstrl: "Day 140 +/- 3 days"
  - code: "V3"
    visit: "Visit 3"
    visitnum: 8
    visitdy: 141
    tvstrl: "Day 141 +/- 5 days"
  - code: "V3_IMG"
    visit: "Visit 3"
    visitnum: 8
    visitdy: 141
  - code: "PFU"
    visit: "Phone Call 5: Follow-up"
    visitnum: 9
    visitdy: 155
    tvstrl: "Day 155 +/- 7 days"

# --- 2.2  Epoch map (optional) ------------------------------------------------
# Study-day windows for epoch assignment. Use null for open-ended bounds.
# Uncomment and fill in when needed.
# epoch_map:
#   - epoch: "SCREENING"
#     start_day: null
#     end_day: -1
#   - epoch: "TREATMENT"
#     start_day: 1
#     end_day: null

# --- 2.3  Timepoint map -------------------------------------------------------
# Planned time points for diary data (e.g. FA, QS).
# Maps the raw activity identifier to TPT, TPTNUM, TPTREF, and ELTM.
tpt_source_var: "activityid"
timepoint_map:
  # Week after Visit 1 (Days 1-7)
  - code: "D1W1_SPI"
    tpt: "Day 1"
    tptnum: 1
    tptref: "Week after Visit 1"
    eltm: "P1D"
  - code: "D2W1_SPI"
    tpt: "Day 2"
    tptnum: 2
    tptref: "Week after Visit 1"
    eltm: "P2D"
  - code: "D3W1_SPI"
    tpt: "Day 3"
    tptnum: 3
    tptref: "Week after Visit 1"
    eltm: "P3D"
  - code: "D4W1_SPI"
    tpt: "Day 4"
    tptnum: 4
    tptref: "Week after Visit 1"
    eltm: "P4D"
  - code: "D5W1_SPI"
    tpt: "Day 5"
    tptnum: 5
    tptref: "Week after Visit 1"
    eltm: "P5D"
  - code: "D6W1_SPI"
    tpt: "Day 6"
    tptnum: 6
    tptref: "Week after Visit 1"
    eltm: "P6D"
  - code: "D7W1_SPI"
    tpt: "Day 7"
    tptnum: 7
    tptref: "Week after Visit 1"
    eltm: "P7D"
  # Week before Phone Call 2 (Days 1-7)
  - code: "D1W5_SPI"
    tpt: "Day 1"
    tptnum: 1
    tptref: "Week before Phone Call 2"
    eltm: "P1D"
  - code: "D2W5_SPI"
    tpt: "Day 2"
    tptnum: 2
    tptref: "Week before Phone Call 2"
    eltm: "P2D"
  - code: "D3W5_SPI"
    tpt: "Day 3"
    tptnum: 3
    tptref: "Week before Phone Call 2"
    eltm: "P3D"
  - code: "D4W5_SPI"
    tpt: "Day 4"
    tptnum: 4
    tptref: "Week before Phone Call 2"
    eltm: "P4D"
  - code: "D5W5_SPI"
    tpt: "Day 5"
    tptnum: 5
    tptref: "Week before Phone Call 2"
    eltm: "P5D"
  - code: "D6W5_SPI"
    tpt: "Day 6"
    tptnum: 6
    tptref: "Week before Phone Call 2"
    eltm: "P6D"
  - code: "D7W5_SPI"
    tpt: "Day 7"
    tptnum: 7
    tptref: "Week before Phone Call 2"
    eltm: "P7D"
  # Week before Visit 2 (Days 1-7)
  - code: "D1W10_SPI"
    tpt: "Day 1"
    tptnum: 1
    tptref: "Week before Visit 2"
    eltm: "P1D"
  - code: "D2W10_SPI"
    tpt: "Day 2"
    tptnum: 2
    tptref: "Week before Visit 2"
    eltm: "P2D"
  - code: "D3W10_SPI"
    tpt: "Day 3"
    tptnum: 3
    tptref: "Week before Visit 2"
    eltm: "P3D"
  - code: "D4W10_SPI"
    tpt: "Day 4"
    tptnum: 4
    tptref: "Week before Visit 2"
    eltm: "P4D"
  - code: "D5W10_SPI"
    tpt: "Day 5"
    tptnum: 5
    tptref: "Week before Visit 2"
    eltm: "P5D"
  - code: "D6W10_SPI"
    tpt: "Day 6"
    tptnum: 6
    tptref: "Week before Visit 2"
    eltm: "P6D"
  - code: "D7W10_SPI"
    tpt: "Day 7"
    tptnum: 7
    tptref: "Week before Visit 2"
    eltm: "P7D"
  # Week before Phone Call 3 (Days 1-7)
  - code: "D1W15_SPI"
    tpt: "Day 1"
    tptnum: 1
    tptref: "Week before Phone Call 3"
    eltm: "P1D"
  - code: "D2W15_SPI"
    tpt: "Day 2"
    tptnum: 2
    tptref: "Week before Phone Call 3"
    eltm: "P2D"
  - code: "D3W15_SPI"
    tpt: "Day 3"
    tptnum: 3
    tptref: "Week before Phone Call 3"
    eltm: "P3D"
  - code: "D4W15_SPI"
    tpt: "Day 4"
    tptnum: 4
    tptref: "Week before Phone Call 3"
    eltm: "P4D"
  - code: "D5W15_SPI"
    tpt: "Day 5"
    tptnum: 5
    tptref: "Week before Phone Call 3"
    eltm: "P5D"
  - code: "D6W15_SPI"
    tpt: "Day 6"
    tptnum: 6
    tptref: "Week before Phone Call 3"
    eltm: "P6D"
  - code: "D7W15_SPI"
    tpt: "Day 7"
    tptnum: 7
    tptref: "Week before Phone Call 3"
    eltm: "P7D"
  # Week before Visit 3 (Days 1-7)
  - code: "D1W20_SPI"
    tpt: "Day 1"
    tptnum: 1
    tptref: "Week before Visit 3"
    eltm: "P1D"
  - code: "D2W20_SPI"
    tpt: "Day 2"
    tptnum: 2
    tptref: "Week before Visit 3"
    eltm: "P2D"
  - code: "D3W20_SPI"
    tpt: "Day 3"
    tptnum: 3
    tptref: "Week before Visit 3"
    eltm: "P3D"
  - code: "D4W20_SPI"
    tpt: "Day 4"
    tptnum: 4
    tptref: "Week before Visit 3"
    eltm: "P4D"
  - code: "D5W20_SPI"
    tpt: "Day 5"
    tptnum: 5
    tptref: "Week before Visit 3"
    eltm: "P5D"
  - code: "D6W20_SPI"
    tpt: "Day 6"
    tptnum: 6
    tptref: "Week before Visit 3"
    eltm: "P6D"
  - code: "D7W20_SPI"
    tpt: "Day 7"
    tptnum: 7
    tptref: "Week before Visit 3"
    eltm: "P7D"

# --- 2.4  Inclusion/Exclusion criteria ----------------------------------------
# Used by the TI domain and validated against IE.
ie_criteria:
  tivers: "1.1"
  criteria:
    - ietestcd: "INCL01"
      ietest: "Male or female subject aged >= 18 years at the time of signing informed consent"
      iecat: "INCLUSION"
    - ietestcd: "INCL02"
      ietest: "Willing and able to provide written informed consent"
      iecat: "INCLUSION"
    - ietestcd: "INCL03"
      ietest: "Body Mass Index (BMI) between 18.5 and 35.0 kg/m2 at screening"
      iecat: "INCLUSION"
    - ietestcd: "INCL04"
      ietest: "Generally in good health as determined by the investigator"
      iecat: "INCLUSION"
    - ietestcd: "INCL05"
      ietest: "Willing and able to comply with the study protocol and scheduled visits"
      iecat: "INCLUSION"
    - ietestcd: "INCL06"
      ietest: "Female subjects of childbearing potential must agree to use adequate contraception"
      iecat: "INCLUSION"
    - ietestcd: "INCL07"
      ietest: "Able to read and understand the language of the study materials"
      iecat: "INCLUSION"
    - ietestcd: "INCL08"
      ietest: "Willing to maintain current dietary habits for the duration of the study"
      iecat: "INCLUSION"
    - ietestcd: "EXCL01"
      ietest: "Known allergy or hypersensitivity to any component of the study product"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL02"
      ietest: "Currently pregnant or lactating, or planning to become pregnant during the study"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL03"
      ietest: "Participation in another clinical study within 30 days prior to screening"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL04"
      ietest: "Use of antibiotics within 14 days prior to the first study visit"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL05"
      ietest: "Diagnosis of any chronic gastrointestinal disease"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL06"
      ietest: "History of major gastrointestinal surgery within 6 months of screening"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL07"
      ietest: "Current use of immunosuppressive medications"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL08"
      ietest: "Significant renal or hepatic impairment as judged by the investigator"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL09"
      ietest: "Any condition that, in the opinion of the investigator, may compromise subject safety"
      iecat: "EXCLUSION"
    - ietestcd: "EXCL10"
      ietest: "Inability to comply with the study requirements"
      iecat: "EXCLUSION"

# --- 2.5  RELREC — Related Records -------------------------------------------
# Defines cross-domain relationships used to build the RELREC dataset.
# Types:
#   record       – link columns in raw data (e.g. cmae1 in cm_whodrug)
#   identity     – 1:1 SPID match across built domains (e.g. XS<>AE via XSSPID=AESPID)
#   seq_lookup   – raw link column + built domain SEQ lookup (e.g. DS<>AE)
#   domain       – static dataset-level relationship (no per-subject data)
relrec:
  - rdomain1: CM
    rdomain2: AE
    type: record
    dataset: cm_whodrug
    link_prefix: cmae
    idvar1: CMSPID
    idvar2: AESPID
    idvar1_val_col: cmspid
  - rdomain1: CM
    rdomain2: MH
    type: record
    dataset: cm_whodrug
    link_prefix: cmmh
    idvar1: CMSPID
    idvar2: MHSPID
    idvar1_val_col: cmspid
  - rdomain1: PR
    rdomain2: AE
    type: record
    dataset: pr
    link_prefix: prae
    idvar1: PRSPID
    idvar2: AESPID
    idvar1_val_col: prspid
  - rdomain1: PR
    rdomain2: MH
    type: record
    dataset: pr
    link_prefix: prmh
    idvar1: PRSPID
    idvar2: MHSPID
    idvar1_val_col: prspid
  - rdomain1: XS
    rdomain2: AE
    type: identity
    idvar1: XSSPID
    idvar2: AESPID
  - rdomain1: DS
    rdomain2: AE
    type: seq_lookup
    dataset: eos
    link_col: etae1
    idvar1: DSSEQ
    idvar2: AESPID
    filter_col: DSCAT
    filter_val: DISPOSITION EVENT
