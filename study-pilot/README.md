# STUDY-PILOT — sdtmbuilder Demo

This folder demonstrates how to use the `sdtmbuilder` package to build
SDTM domains (AE, MH, CM, PR) for the STUDY-PILOT pilot study.

## Folder Structure

```
study-pilot/
├── config.yaml                 # Study configuration
├── run_ae_demo.R               # AE domain demo
├── run_mh_demo.R               # MH domain demo
├── run_cm_demo.R               # CM domain demo
├── run_pr_demo.R               # PR domain demo
├── create_dummy_raw.R          # Generate dummy raw data
├── README.md                   # This file
├── metadata/
│   ├── Study_Metadata.xlsx     # SDTM variable definitions (target metadata)
│   └── Study_CT.xlsx           # Controlled terminology (codelists)
├── raw/                        # Place raw data here (or set path in script)
└── sdtm/                       # Output (created by the script)
    ├── datasets/               # ae.xpt, ae.rds, suppae.xpt
    └── programs/               # ae.R (auto-generated derivation program)
```

## How to Run

1. **Install sdtmbuilder** (if not already installed):
   ```r
   devtools::install("path/to/sdtm-builder")
   ```

2. **Edit `run_ae_demo.R`** — set `RAW_DATA_DIR` to the path containing your
   raw datasets (ae_meddra, sae, dm as `.sas7bdat`, `.csv`, or `.xpt` files).

3. **Run the script**:
   ```r
   source("run_ae_demo.R")
   ```

## Raw Data Requirements

The AE domain requires these raw datasets (matching the original SAS program):

| Dataset      | Description                          | Key Variables                                                    |
|-------------|--------------------------------------|------------------------------------------------------------------|
| `ae_meddra` | AE data with MedDRA coded terms      | subjectid, aespid, aeterm, aestdat, aeendat, aesev, aeser, ...  |
| `sae`       | SAE seriousness criteria             | subjectid, saespid, aesdth, aeslife, aeshosp, aesdisab, ...     |
| `dm`        | Demographics (for USUBJID, RFSTDTC)  | subjectid, icdat (or rfstdtc), sitecode, ...                    |

The demo script pre-merges `ae_meddra` + `sae` into `ae_raw` (replicating the
SAS `data ae_all; merge ...` step), and the DM merge for RFSTDTC is handled
automatically by `build_domain()`.

## What the Script Does

1. Reads `Study_Metadata.xlsx` and `Study_CT.xlsx`
2. Loads raw data from `RAW_DATA_DIR` and pre-merges AE sources
3. Compiles derivation rules from the metadata METHOD column
4. Builds the AE domain (54 variables, including MedDRA hierarchy, dates, CT)
5. Exports AE as XPT and RDS
6. Generates an auto-documented R derivation program (`sdtm/programs/ae.R`)

## Notes

- The METHOD column in Study_Metadata.xlsx maps each target variable to
  an sdtmbuilder derivation function call.
- Raw data is synthetic (generated by `create_dummy_raw*.R` scripts).
